main.py

import streamlit as st
import os
import json
import base64
import google.generativeai as genai
from PIL import Image
from typing import List, Dict, Any

# --- CONFIGURATION ---
st.set_page_config(page_title="Marketplace Genie", page_icon="üßû", layout="wide")

# --- API SETUP (The Free Way) ---
# We use st.secrets for Streamlit Cloud deployment
if "GOOGLE_API_KEY" in st.secrets:
    genai.configure(api_key=st.secrets["GOOGLE_API_KEY"])
else:
    st.error("Missing GOOGLE_API_KEY in Secrets!")

# --- CUSTOM CSS ---
st.markdown("""
<style>
    .stProgress > div > div > div > div { background-color: #0084FF; }
    .stButton>button { width: 100%; border-radius: 8px; font-weight: bold; }
</style>
""", unsafe_allow_html=True)

# --- SESSION STATE ---
if 'step' not in st.session_state:
    st.session_state.step = 1
if 'item_details' not in st.session_state:
    st.session_state.item_details = {}
if 'media' not in st.session_state:
    st.session_state.media = []

# --- AI LOGIC (Gemini Free Tier) ---
def generate_listing_gemini(item_details: Dict, media_files: List):
    model = genai.GenerativeModel('gemini-1.5-flash')
    
    prompt = f"""
    Act as an expert reseller. Generate a marketplace listing for:
    Item: {item_details.get('name')}
    Condition: {item_details.get('condition')}
    Specs: {item_details.get('specs')}
    Notes: {item_details.get('notes')}
    
    Return ONLY a JSON object with these keys: 
    "target_price", "floor_price", "title", "description", "tags", "photo_strategy", "timeline"
    """
    
    content = [prompt]
    
    # Process images for Gemini
    if media_files:
        for uploaded_file in media_files:
            if uploaded_file.type.startswith("image"):
                img = Image.open(uploaded_file)
                content.append(img)

    try:
        response = model.generate_content(content)
        # Clean the response to ensure it's valid JSON
        json_text = response.text.replace('```json', '').replace('```', '').strip()
        return json.loads(json_text)
    except Exception as e:
        return {"error": str(e)}

# --- NAVIGATION ---
def next_step(): st.session_state.step += 1
def prev_step(): st.session_state.step -= 1

# --- APP UI ---
st.title("üßû Marketplace Genie (Free Edition)")

if st.session_state.step == 1:
    st.subheader("üìù Item Details")
    name = st.text_input("Item Name", placeholder="e.g. Sony WH-1000XM5")
    col1, col2 = st.columns(2)
    with col1:
        orig_price = st.number_input("Original Price ($)", min_value=0)
        condition = st.selectbox("Condition", ["New", "Like New", "Good", "Fair"])
    with col2:
        specs = st.text_input("Specs", placeholder="e.g. Black, Noise Cancelling")
    notes = st.text_area("Extra Details")
    
    if st.button("Next: Photos ‚ú®"):
        st.session_state.item_details = {"name": name, "orig_price": orig_price, "condition": condition, "specs": specs, "notes": notes}
        next_step()
        st.rerun()

elif st.session_state.step == 2:
    st.subheader("üì∏ Upload Photos")
    photos = st.file_uploader("Upload item photos", type=["jpg", "jpeg", "png"], accept_multiple_files=True)
    
    col1, col2 = st.columns(2)
    with col1:
        if st.button("‚¨ÖÔ∏è Back"): prev_step(); st.rerun()
    with col2:
        if st.button("Generate Listing üßû"):
            st.session_state.media = photos
            next_step()
            st.rerun()

elif st.session_state.step == 3:
    st.subheader("‚ú® Your Generated Listing")
    
    if 'listing_result' not in st.session_state:
        with st.spinner("Genie is thinking..."):
            res = generate_listing_gemini(st.session_state.item_details, st.session_state.media)
            st.session_state.listing_result = res
            
    result = st.session_state.listing_result
    
    if "error" in result:
        st.error(f"Error: {result['error']}")
    else:
        st.metric("Suggested Price", f"${result.get('target_price')}")
        st.text_input("Title", value=result.get('title'))
        st.text_area("Description", value=result.get('description'), height=200)
        st.info(f"üì∏ Strategy: {result.get('photo_strategy')}")

    if st.button("Start Over üîÑ"):
        st.session_state.step = 1
        st.session_state.item_details = {}
        if 'listing_result' in st.session_state: del st.session_state.listing_result
        st.rerun()
